Den inbyggda prioriteringen av meddelanden har noga avvägts vid fördelningen av de 29 bitar som finns tillgängliga i id-fältet.
Detta fält avgör nämligen meddelandets prioritet på bussen.
De 29 bitarna har fördelats enligt tabell \ref{tab:idbitar}. Meddelandetypen anges i de tre första bitarna då den är mest relevant för att avgöra meddelandets prioritet. Detta innebär t.ex. att ett larmmeddelande alltid har högre prioritet än alla andra typer oavsett enhetens id och andra parametrar i fältet.

\begin{table}[H]
	\centering
	\begin{tabular}{|l|p{0.8\textwidth}|}
		\hline
		Bitar 	& Används till \\ \hline \hline
		28-26	& Meddelandetyp. \\ \hline
		25		& Meddelandets riktning, dvs. till eller från centralenheten. \\ \hline
		24-18	& Mottagarens eller sändarens id, beroende på meddelandets riktning. (Centralenheten har inget id.) \\ \hline
		17-8 & Sessions-id. Detta id är unikt för varje session och används för att förhindra återspelningsattack. \\ \hline
		7-0 & Sekvensnummer. Används bara av meddelanden som bekräftas med ack. \\ \hline

	\end{tabular}
	\caption{Fördelning av de 29 bitarna i ett CAN-meddelandes id-fält.}
	\label{tab:idbitar}
\end{table}


För att motverka återuppspelningsattacker används sessions-id id fältet i id-fältet. Detta fält ingår automatiskt i filtrer för meddelanden och måste därför överenstämma med för alla meddelanden som skickas under en session. Undantaget är id-tilldelningen då sessions-id först aktiveras på periferienheten efter att de mottagit id-tilldelningsmeddelandet. För att aktiverar session-id kopierar de samma session-id som tilldelningsmeddelandet har och kan därefter kommunicera med samma sessions-id som dem andra på närverket. Nedan följer en beskrivning av de meddelanden som används i protokollet.


\textbf{Ack}
\begin{itemize}
	\item Skickas som remote-meddelande
    \item Skickas i båda riktningar
\end{itemize}
Detta meddelande skickas som bekräftelse för ett mottaget meddelandet. Larmmedelanden och konfigurationsmeddelanden (se nedan) är de enda meddelandetyper som bekräftas med ack. Meddelandet har samma id-fält som det mottagna meddelandet men är av typen remote. Meddelandet innehåller därför inget datafält så för att urskilja vilket meddelande som bekräftas används de 8 bitarna för sekvensnummer i id-fältet (se tabell \ref{tab:idbitar}). \\

\textbf{Id-begäran}
\label{idbegäran}
\begin{itemize}
	\item Meddelandetyp 3
	\item Skickas från periferienhet till centralenheten
\end{itemize}
Detta meddelande skickas av en periferienhet innan den har tilldelats ett id. 
De sju bitarna i id-fältet som annars ska ange periferienhetens id är bara nollor.
Då periferienheten i denna fas saknar id skickar den ett tillfälligt 32-bitars slumpgenererat id i datafältets första fyra bytar, för att låta centralenheten särkilja den från andra periferienheter som begär id.
Om periferienheten inte tar emot sitt id och därför skickar en ny begäran görs detta med samma tillfälliga id, vilket låter centralenheten tilldela den samma id igen.

\textbf{Tilldelning av id}
\label{idtilldelning}
\begin{itemize}
	\item Meddelandetyp 2
	\item Skickas från centralenheten till periferienhet
\end{itemize}
Detta meddelande skickas då centralenheten har tagit emot en id-begäran. Det skickas endast i startläge. I de första fyra bytarna av datafältet skickas samma tillfälliga id som periferienheten skickade i begäran. I den femte byten skickas det riktiga id:t. \\
Om det är första gången centralenheten får en id-begäran från just denna periferienhet skickar den det lägsta lediga id:t (minst 0). Om centralenheten däremot hittar det tillfälliga id:t i sin lista med periferienheter skickar den samma id igen för att förhindra att flera periferienheter tilldelas samma id.


\textbf{Konfiguration}
\begin{itemize}
    \item Meddelandetyp 1
    \item Skickas från centralenheten till preferienhet
\end{itemize}	
Detta meddelande används för att skicka konfigurationer till periferienheterna.
Centralenheten skickar konfiguration till periferienheten kontinuerligt under drift för att försäkra sig om att periferienheten har rätt konfiguration. Detta fungerar även som ping, då ett bestämt antal uteblivna ack tolkas som att enheten inte längre finns på nätverket.
I så fall uppmärksammar centralenheten detta. Konfigurationsmeddelanden ser olika ut för de olika enheterna.

För dörrenheter fördelas datafältet enligt tabell \ref{dörrkonfdata}

\begin{table}[htb]
	\centering
	\begin{tabular}{|l|l|}
		\hline
		Byte & Innehåll \\ \hline \hline
		0 & Id till första dörren i intervallet \\ \hline
		1 & Id till sista dörren i intervallet \\ \hline
		2-3 & Fördröjning för lokalt larm (multipel av 10 sekunder) \\ \hline
		4-5 & Fördröjning för centralt larm (multipel av 10 sekunder) \\ \hline
		6 & Tillstånd (uppställd eller låst) \\ \hline
	\end{tabular}
	\caption{Datafältets fördelning för konfiguration av dörrenhet.}
	\label{tab:dörrkonfdata}
\end{table}



För rörelseenheter fördelas datafältet enligt tabell \ref{tab:rörelsekonfdata} vid konfigurering och enligt tabell \ref{tab:rörelsekaldata} vid kalibrering.
\begin{table}[htb]
	\centering
	\begin{tabular}{|l|l|}
		\hline
		Byte & Innehåll \\ \hline \hline
		0 & Typ av sensor (rörelse eller vibration) \\ \hline
		1 & Anger huruvida rörelseenheten ska konfigureras eller kalibreras \\ \hline
		2 & Id till första sensorn i intervallet \\ \hline
		3 & Id till sista sensorn i intervallet \\ \hline
		4 & Sensorernas tillstånd (aktiva eller inaktiva) \\ \hline
		5-6 & Larmavstånd (endast för rörelsesensorer) \\ \hline
		7 & Avlarmning (gör inget eller avlarma) \\ \hline
	\end{tabular}
	\caption{Datafältets fördelning för konfiguration av rörelseenhet.}
	\label{tab:rörelsekonfdata}
\end{table}

\begin{table}[htb]
	\centering
	\begin{tabular}{|l|l|}
		\hline
		Byte & Innehåll \\ \hline \hline
		1 & Anger huruvida rörelseenheten ska konfigureras eller kalibreras \\ \hline
		2 & Sensorns id\\ \hline
		5-6 & Upmätt avstånd\\ \hline
	\end{tabular}
	\caption{Datafältets fördelning för kalibrering av rörelseenhet.}
	\label{tab:rörelsekaldata}
\end{table}


\textbf{Larm}
\begin{itemize}
	\item Meddelandetyp 0
	\item Skickas från periferienhet till centralenheten
\end{itemize}	
Talar om för centralenheten om någon dörr eller sensor larmar. Detta meddelande skickas endast av periferienheterna. I datafältet skickas id:t för sensorn som larmar. Samma id används även som sekvensnummer för meddelandet.\\
