\documentclass{article}
\usepackage[swedish]{babel}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}

%Lägger till Referenser i Innehållsförteckningen
\usepackage{tocbibind}
\usepackage{float}
\usepackage{amsmath}
\usepackage{parskip}
\usepackage{todonotes}
\usepackage{url}
\usepackage{hyperref}
\usepackage{multicol}

\title{Utveckling av modulärt larmsystem baserat på MD407-enkortsdatorer}

\author{\large Grupp 13\\Filip Borg, Gustav Fåhraeus, Josef Karlsson,\\
Erik Nilsson, Adam Thörnblom, Ben Wooldridge}
\date{Läsperiod 1, HT-2019\\DAT290 Datatekniskt projekt\\Datateknik}

% I utvärderingen granskas hur väl studenterna i sina rapporter har lyckats visa att de genom de teknikutvärderingar, konstruktionsval, tester och analys som de har gjort har förstått de problem de har ställts inför, samt hur de på basis av denna förståelse och utifrån rådande förutsättningar har lyckats agera för att lösa dessa problem.

% Kriterierna är läsarorienterade vilket innebär att de ska bedöma en utomstående läsaresmöjligheter att förstå rapporten. Rapporten ska först och främst ses som ett dokument vars läsare finns inom organisationen där arbetet sker,men det ska kunna läsas och förstås av personer som inte har jobbat med och därför inte är insatta i projektet, exempelvis en nyanställd som inte känner till projektet och dess bakgrund, en anställd i en annan organisation med liknande verksamhet eller en ingenjörsstudent inom datateknik som har gått en liknande utbildning på en annanhögskola.

% En bakåtsyftande projektrapport: “Rapporten beskriver utvecklingen av…”



\usepackage{blindtext}

\makeatletter
\renewcommand{\contentsname}{Table of Contents}

\newlength{\tocheaderrulewidth}
\setlength{\tocheaderrulewidth}{2pt}

\renewcommand\tableofcontents{%
  \begingroup
  \parindent=0em
  \section*{\contentsname
        \@mkboth{%
           \MakeUppercase\contentsname}{\MakeUppercase\contentsname}}%
   \endgroup

  \@starttoc{toc}%
 }
\makeatother

\begin{document}

%Titelsida
\maketitle
\pagenumbering{gobble}
\clearpage

\tableofcontents
\clearpage


\section*{Beteckningar}
\begin{itemize}
    \item \textbf{MD407} – En ARM-baserad
    laborationsdator för utbildning
    \item \textbf{ARM} - En processor-arkitektur
    \item \textbf{CAN} - Controller Area Network
    \item \textbf{GPIO} - General-purpose input/output
    \item \textbf{USART} - Universal asynchronous receiver-transmitter
    \item \textbf{LED} - Light-emitting diode
    \item \textbf{AUX} - Auxiliary
\end{itemize}
\newpage
\pagenumbering{arabic}

\section{Inledning}
I en undersökning\cite{brott-foretagarna} utförd av Sveriges största företagsorganisation, \textit{Företagarna}, anger var tredje företag (n=983) att de blivit utsatta för minst ett brott någon gång under de senaste fem åren. Pontus Lindström, ansvarig för brott- och trygghetsfrågor hos Företagarna säger:
\begin{quote}
\textit{- Undersökningen bekräftar den bild vi har. Många företagare vittnar om en ökad utsatthet och om att otryggheten ökat.\cite{brott-foretagarna}}
\end{quote}

25\% av de företag som blivit utsatta för minst ett brott anger att de inte anmält brottet till polisen. 36\% anger att de anmält något av brotten de utsatts för. Att anmälningsgraden är så låg tyder på att att företagen inte anser att det är värt besväret att anmäla brott till polisen. Företagen i undersökningen anger också att de känner sig tvungna att satsa stora summor på larmsystem, vilket för många enskilda firmor och handelsbolag inte alltid är genomförbart av finansiella skäl.

Baserat på denna undersökning verkar det finnas ett behov av ett skalbart larmsystem där användaren kan justera larmsystemets omfattning baserat på rådande nödvändighet och finansiell kapabilitet.

Rapporten beskriver utvecklingen av ett modulärt larmsystem som i grunden består av MD407-enkortsdatorer\cite{MD407}.

\subsection{Syfte} % Svarar på frågan "Varför"?
Projekets syfte är att utveckla ett larmsystemets som ska vara ett finansiellt dynamiskt alternativ för företag
och organisationer som har behov av skalningsbar och anpassningsbar larmning beroende på nuvarande nödvändighet och finansiell \\ kapabilitet.
Detta uppnås genom att erbjuda mindre delsystem som kan kopplas ihop till ett större centraliserat system.

Systemet ökar översikten och säkerheten av användarens lokaler genom att implementera konfigurerbar larmning av dörrar, samt rörelse- och vibrationsdetektering.

\subsection{Mål} % Svarar på frågan "Vad"?
% I detta avsnitt beskrivs koncist samtliga övergripande tekniska mål med projektet, det vill säga, vad som ska konstrueras. De mål som anges här kommer att styra projektets utveckling. När projektet närmar sig sitt slut och den slutliga projektrapporten lämnas in kommer beställaren att kritiskt analysera hur väl projektet lyckats genom att jämföra planens mål med den tekniska konstruktion som redovisas i projektrapporten.
Ett komplett larmsystem i minimal form består av tre enheter: en dörrenhet, en rörelseenhet, och en centralenhet.
Samtliga enheter kräver varsin MD407-enkortsdator för individuell drift. För att koppla samman
fristående enheter till ett centraliserat system används en CAN-buss.
CAN-kommunikationen bygger på ett fåtal meddelanden som sköter den informationsdelning som systemet kräver. Informationen som skickas på CAN-nätverket skyddas från återuppspelningsattack där tidigare inspelad trafik återuppspelas vid ett senare tillfälle.

Dörrenheten hanterar detektering och larmning av dörrar. Vid systemuppstart kontrollerar
dörrenheten antalet dörrar kopplade på enkortsdatorn. Datarepresentationer av dessa dörrar skapas, vilket möjliggör för dörrarna att efter en förutbestämd tid utlösa lokala larm genom att en LED-lampa på den larmande dörren tänds.
Dörrarna kan skicka centrala larm via en CAN-buss till centralenheten. Tider innan respektive larm utlöses kan konfigureras från centralenheten.
Från centralenheten kan dörrar också avlarmas, vilket hindrar samtliga larm på dörren från att utlösas.

Röreleseenheten består av en rörelse- och en vibrationssensor. Om endera sensor
utlöses skickas ett centralt larm via en CAN-buss till centralenheten. Känsligheten
på rörelsesensorn konfigueras från centralenheten. Vibrationssensorn konfigueras direkt på hårdvaran.

Centralenheten hanterar konfiguration av periferienheterna, samt fungerar som en
central för samtliga centrala larm som utlöses i systemet. Om ett centralt larm utlöses kan det endast ackkrediteras och nollställas via centralenheten.
\subsection{Arbetsmetod} % svarar på frågan "hur har vi gått tillväga i det tekniska utvecklingsarbetet"?

I det här avsnittet beskrivs hur den tekniska utvecklingen gått till.


\subsubsection{Utveckling}

Utvecklingen av mjukvaran har främst skett på enhetsnivå, dvs. mjukvaran på de olika enheterna har utvecklats separat från varandra.
När samtliga enheter hade uppnått majoriteten av sin tänkta funktionalitet så bytte utvecklingen fokus till att få enheterna att kommunicera med varandra via en CAN-buss.

Periferienhets-grupperna byggde först system för att hantera initiering av relevanta GPIO-portar samt debugfunktioner, och fortsatte med att implementera funktioner för avmätning av sensorerna. Funktionalitet byggdes på och det sista som utvecklades var kommunikationen mellan periferienheterna och centralenheten.

På centralenheten utvecklades först USART, samt ett antal debugfunktioner som kunde användas av alla enheter. Implementeringen av CAN-kommunikation på centralenheten påverkade i hög grad hur CAN implementerades på de andra enheterna, då centralenheten är den som tar emot och skickar flest meddelanden.

Stora majoriten av mjukvaruutvecklingen och test har utförts på hårdvaran som beskrivs i rapporten, men en del av utvecklingen har skett med hjälp av simulerad hårdvara.

\subsubsection{Programbibliotek}
\label{stm}
Ett STM32F4-biblioteket har använts för att spara arbetstid.
Programbiblioteket STM32F4\cite{stm} användes för:
\begin{itemize}
    \item Initieringar och avläsning av enkortsdatorernas GPIO-portar.
    \item Implementation av en SystemTimer (SysTick).
    \item "Väntetid"-funktionalitet. (Fördröjningsfunktioner)
    \item Implementation av CAN-kommunikation.
\end{itemize}



\subsubsection{Verifikation}
\label{verifikation}
För att utvärdera huruvida larmsystemet uppnår de mål och krav som formulerats i målet används tester.
De tre undergrupperna har skrivit tester för sina respektive delsystem som försäkrar att delsystemen fungerar enligt specifikationen. Ett test som är skrivet av en undergrupp utförs av en annan undergrupp för att minimera partiskhet i utförandet.

Testet för det kompletta centraliserade systemet formulerades och utfördes av gruppen som helhet.

För att se samtliga testspecifikationer, samt resultat och analys, se bilaga \ref{bilaga:tester}.

\subsubsection{Fildelning och versionshantering}
Arbetsgruppen valde att använda versionshanteringstjänsten GIT för att förenkla den parallella programmeringen, och för att samla alla filer på ett ställe. GIT-filsamlingen förvarades med hjälp av tjänsten Github. GIT-tjänsten har fungerat väl och även underlättat dokumentering, då även den förvarades i filsamlingen.

\newpage
\section{Teknisk beskrivning} % Vad är utgångspunkten för i förkonstruktionsarbetet?
I detta avsnitt presenteras teknisk information som är nödvändig för att få en djupare insikt i hur den tekniska utvecklingen gått till, samt hur de olika delsystemen fungerar och interagerar för att bygga upp systemet som helhet.
\subsection{Teknisk bakgrund}
Mjukvaran till larmsystemet körs på ett flertal MD407-enkortsdatorer, en för varje enhet.

\textbf{STM32-Programbibliotek}\cite{stm} är ett programbibliotek som har vanliga funktioner som ofta används för ARM


\textbf{Polling} är ett protokoll som kontinuerligt frågar alla I/O-enheter om de behöver processering.\subsection{Systemöversikt}

Systemet utgår från en centralenhet, kopplad till ett antal, max 32, dörrenheter och rörelsenheter över en gemensam CAN-buss. Periferienheterna hanterar avmätning av sina respektive sensorer, samt begär larm via CAN-bussen vid behov. När det går ett centralt larm fortsätter larmet tills en användare slår av larmet via kommandon till centralenheten.

Dörrenheten är kopplad till ett antal strömbrytare/dörrsensorer, och larmar då en dörr är öppen för länge, först lokalt och sedan centralt. Det larmas även centralt då en dörrsensor kopplas ur.

Rörelseenheten har ett antal rörelse- och vibrationsensorer inkopplade. Rörelsesensorerna har centralt samt ett lokalt larm med det dubbla avståndet
som larmar centralt respektive lokalt när sensorn detekterar något innaför dess larmavstånd.
Rörelseenheten larmar även centralt när en vibrationssensor mäter en vibration.

En översikt av hårdvaran och hur den är kopplad finns i Figur \ref{fig:hårdvara}. Värt att notera i figuren är att den endast visar en enhet av varje typ, samt bara en sensor av varje typ, medan det i själva verket kan kopplas in upp till 32 enheter till systemet.
\begin{figure}[H] % Samma figur som projektplanen, då hårdvaran fortfarande ser likadan ut, det är värt att göra en ny innan slutgiltiga rapporten.
    \centering
    \includegraphics[width=1\textwidth]{figurer/HardvaraOversikt.png}
    \caption{Översikt över hårdvara}
    \label{fig:hårdvara}
\end{figure}

När centralenheten samt periferienheterna startar befinner de sig i konfigurationsläge, där varje enhet konfigurerar sig på lokal nivå (USART, CAN-bussen, GPIO), varpå centralenheten skickar konfigurationer till periferienheterna, som de använder för att konfigurera sina respektive sensorer.
Efter att ha konfigurerats går enheterna in i var sin kontinuerlig loop. Periferienheterna mäter ständigt av sensorerna och skickar larm-meddelanden över CAN-bussen till centralenheten vid behov. Centralenheten skickar periodiskt konfigurationer till periferienheterna och larmar ifall dessa inte bekräftas.

En överblick av mjukvarans tidsflöde finns i figur \ref{fig:tidsflöde}.

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{figurer/TidsFlode.jpg}
    \caption{En översiktlig beskrivning av logik-flödet för systemets mjukvara. Övre halvan för varje enhet är en initieringsfas,
    och nedre halvan representerar enheternas 'huvudloop' som är aktiv när systemet är i drift.}
    \label{fig:tidsflöde}
\end{figure}

\subsection{CAN-kommunikation}
\label{can}
Här presenteras protokollet som har utvecklats för informationsutbyte mellan enheterna därefter följer en implementationsbeskrivning.

\subsubsection{Beskrivning av CAN-protokollet}
Protokollet som har utvecklats för kommunikationen mellan enheterna bygger på protokollet Controller Area Network (CAN).
CAN är ett bussprotokoll som främst används för kommunikation mellan datorer och givare på fordon där det ställs höga krav på tillförlitlighet.
För att undvika kollisioner och därmed öka tillförlitligheten har CAN en dominant logisk nivå (0) som dessutom ger automatisk prioritering av meddelanden då den dominanta nivån har företräde på bussen.
Denna prioritering har använts för att ge brådskande meddelanden företräde över meddelanden som inte kräver kort responstid. I tabell \ref{tab:meddelandetyper} är de meddelandetyper som används kortfattat beskrivna. För en mer detaljerad beskrivning av protokollet och dess meddelandetyper, se bilaga \ref{bilaga:protokoll}. För att motverka en återuppspelningsattack beskriver en del av meddelandet vilken session som meddelandet tillhör. Om det sedan skickas ett meddelande för en annan session så ignoreras det.



\begin{table}[H]
	\centering
    \begin{tabular}{|l|p{0.7\textwidth}|}

		\hline
		Meddelandetyp & Används till \\ \hline \hline
		Bekräftelse		& Bekräftelse för det senast mottagna meddelandet. \\ \hline
		Skicka larm		& Talar om för centralenheten om någon dörr eller sensor larmar. \\ \hline
		Konfiguration		& Används för att skicka sensorkonfiguration och kalibrering. \\ \hline
		Tilldelning av id		& Används då centralenheten tilldelar en periferienhet dess id. \\ \hline
		Id-begäran		& Används för att begära ett id. \\ \hline

	\end{tabular}
	\caption{Meddelandetyper som används för datakommunikationen.}
	\label{tab:meddelandetyper}
\end{table}


\subsubsection{Implementation}
För hantering av CAN-meddelanden har STM-biblioteket (se \ref{stm}) använts för inledande initiering,
hantering av avbrott och att skicka meddelanden.
Utöver det har ett system utvecklats för att hantera mottagna meddelanden med hjälp av avbrott.
Hanteringsfunktionen paras ihop med filtret för tillhörande meddelande.
Hanteringsfunktionen anropas sedan av avbrottsrutinen då ett meddelande passerat filtret.
Denna lösning har valts då de flesta meddelanden naturligt hanteras med en kort hanteringsfunktion
som inte kräver input från användaren.


\subsection{USART}
För att ge användaren möjlighet att interagera med systemet har Universal asynchronous receiver-transmitter (USART) implementerats. USART sköter kommunikationen mellan mikrodatorn och den terminal som används då mikrodatorn är ansluten till en dator. Via terminalen får användaren utskrifter från programmet och har även möjlighet att ge kommandon till systemet.


\subsection{Störenhet}
För att ge möjlighet att testa systemet på ett tungt trafikerat CAN-nätverk har en störenhet utvecklats. Störenheten skickar frekvent meddelanden med slumpartat innehåll. Hastigheten är reglerbar via USART. Utöver att generera brus kan enheten också fungera som en lyssnare med avaktiverad störfunktion.

\subsection{Återspelningsenhet}
För att säkerställa att åtgärden för att hindra återspelningsattacker fungerar som den ska har en återspelningsenhet tagits fram. Enheten kopplas upp på bussen och kan därefter spela in den trafik som skickas. Inspelningsbuffern har möjlighet att lagra 1000 meddelanden som på begäran kan skickas på nytt när en attack vill simuleras. Enheten kan sköta inspelning och uppspelning samtidigt och har dessutom inställningsmöjlighet för att återupprepa uppspelningen då man spelat upp alla meddelanden.


\subsection{Delsystem }
Varje egen enhet ses som en del utav det hela systemet. Dessa tre delsystem är
centralenheten, dörrenheten och rörelseenheten. I det här avsnittet beskrivs de
olika delsystemen.
\subsubsection{Centralenheten}
\label{subsec:centralenhet}

Centralenheten styr och har uppsikt över periferienheterna enligt figur \ref{fig:centralflöde}.
Inställningar görs via USART med kommandon enligt bilaga \ref{kommandon}, varpå de vidarebefordras till rätt periferienhet via CAN.

\begin{figure}[H]
    \centering
    \includegraphics[scale=0.3]{figurer/Centralenhet.png}
    \caption{Flödesschema för centralenhetens viktigaste funktionalitet.}
    \label{fig:centralflöde}
\end{figure}

Centralenheten har följande två lägen:

\begin{description}
    \item[Startläge] Då centralenheten är i detta läge kan periferienheter ansluta sig till den genom att skicka en id-förfrågan via CAN, varpå centralenheten skickar tillbaka ett unikt id. Detta id används sedan för att adressera och identifiera periferienheten, se \ref{idbegäran} och \ref{idtilldelning}


    \item[Standardläge] Enheten väntar på larm-meddelanden från periferienheterna eller användarinput via USART. Dessutom skickar den regelbundet konfigurationen för anslutna dörrar och sensorer till periferienheterna, som förväntas bekräfta konfigurationen.
    Om en enhet inte svarar efter ett antal meddelanden går larmet.
\end{description}
I båda lägen kan användaren hantera periferienheterna genom konfigurationsändringar. För lösenordsskyddade kommandon används en knappsats som låter användaren logga in med en fyrsiffrig pinkod.


\subsubsection{Dörrenheten}
\label{subsec:Dörrenheten}
% Punkter att få med:
% - Systemuppstart
% - Lokala / Centrala Larm
% - CAN
% - Initiering?
% - Systick?
% - Bilder?

Dörrenheten är den periferienhet som sköter uppsikten över användarens dörrar. Enheten kräver en MD407-enkortsdator för drift.

För att koppla upp en dörr till systemet krävs det två anslutningar till en av mikrodatorns GPIO-portar: en koppling som går från en strömbrytare på dörren till en av mikrodatorns jämna I/O-pinnar (\textit{n}), samt en koppling från en LED-lampa på dörren till en udda I/O-pinne (\textit{n+1}).

Fyra av mikrodatorns fem portar är designerade för dörranslutningar (\textit{A,C,D,E}). \\
Eftersom samtliga portar har 16 tillgängliga pinnar innebär det att systemet maximalt kan stötta 32 dörrar per dörrenhet.

Port B är inte avsedd för dörranslutningar, utan används främst för CAN-\\kommunikationen
med centralenheten. En LED-lampa kan även kopplas till \\ pinne 2 på port B. Denna lampa signalerar vid uppstart när systemets initiering är färdig.

Vid uppstart initieras först portarna och pinnarna på mikrodatorn så att de kan adresseras
och avläsas på rätt sätt. Därefter startas en System Timer (SysTick) som fungerar som klocka för delsystemet.
Då klockan är startad initieras CAN på port B, vilket möjliggör kommunikation med centralenheten. Fortsättningsvis detekterar systemet hur många dörrar som är kopplade på kortet, och på vilka pinnar de är kopplade. För att dörrarna ska kunna detekteras krävs det att de är stängda.

Under detekteringen skapas datarepresentationer med förinställda värden för de dörrar som systemet
hittat. Efter att samtliga datarepresentationer är skapade kommer systemet att försöka kommunicera med centralenheten. Om en centralenhet inte svarar kommer systemet att gå in i lokal drift, vilket innebär att funktionaliteten med centrala larm uteblir.
Fortsättningsvis så tänds lamporna på dörrarna i den ordning som dess datarepresentationer skapades. Detta görs för att testa om de lokala larmen fungerar hos dörrarna. Efter att samtliga lampor är tända släcker systemet dem igen.
Slutligen tänds lampan som är kopplad till pinne 2 på port B för att signalera till användaren att enheten är redo för drift. Systemet kommer i fortsättningen kontinuerligt att skicka ut meddelanden till en eventuell centralenhet på CAN-nätverket med jämna mellanrum, vilket medför att en centralenhet kan kopplas in utan att systemet behöver startas om.

Systemet kontrollerar fortlöpande alla dörrar enligt flödesdiagrammet i figur \ref{fig:dörrflöde}:



\begin{figure}[H]
\begin{flushleft}
\end{flushleft}
\centering
\includegraphics[scale=0.5]{figurer/Flow-Chart.png}
\caption{Flödesschema över dörrenhetens funktionalitet som visar vilka beslut systemet tar beroende på externa och interna händelser.}
\label{fig:dörrflöde}
\end{figure}

Dörrenhetens flöde bygger på polling. Samtliga dörrar har i sina datarepresentationer
ett antal kontrollbitar. I flödesschemat i figur 3 är dessa kontrollbitar representerade
som 'beslut' som anger huruvida en kontrollbit är satt till 1 (för \textit{ja}) eller 0
(för \textit{nej}). Dessa kontrollbitar sätts till 1 eller 0 beroende på externa händelser.

Avlarmning av en specifik dörr sker via CAN-kommunikation från centralenheten. Att en dörr är avlarmad
innebär att dess larm inte kan utlösas.

Att en dörr är öppen innebär att kretsen som går via strömbrytaren på dörren inte längre är sluten.
Om kretsen inte är sluten, och dörren inte är avlarmad, tyder det på att någonting externt har hänt
som systemet bör ta hänsyn till. Hur lång tid systemet väntar innan det larmar lokalt konfigureras i
 10-sekunders intervall via centralenheten. Väntetiden kan vara allt från 0 sekunder till ca 40 minuter
   (maxtiden är $2^8 *10$ sekunder).

När dörrenheten larmar centralt så skickas ett meddelande via CAN till centralenheten. Meddelanden
kommer skickas med intervall på en sekund tills centralenheten skickar tillbaka en ackreditering om att larmet har
 mottagits.

När dörrenheten larmar lokalt tänds en lampa på dörren. Detta larmet kan kompletteras med ett  ljud
genom att koppla in en högtalare på pinne A5 (port A, pinne 5). Ljudlarmet utlöses oavsett vilken dörr kopplad på enkortsdatorn som larmar. Användning av ljudlarmet sker på bekostnad av en dörr, då en dörr inte längre kan kopplas på A4-A5.


\subsubsection{Rörelseenheten}
Denna periferienhet använder avståndsmätare av modellen HC-SR04\cite{HC-SR04} till rörelsesensorer,
 och vibrationssensorer av modellen SW-18010P\cite{SW-18010P}, som styrs av ett MD407-enkortsdator.

Rörelseenheten använder fyra av enkortsdators fem GPIO-portar, port A, C, D och E.
Port B har många designerade pinnar till CAN med mera och är därför utesluten som
sensorport. Portarna är uppdelade mellan port A och C till rörelsesensorerna,
och port D och E till vibrationssensorerna. Dock har GPIO-port A har vissa designerade pinnar
till bland annat USART , därför går det ej att koppla sensorer till dessa (se tabell \ref{tab:Ogiltliga pinnar}).

\begin{table}[htbp]
	\centering
	\begin{tabular}{|c|c|} \hline
		GPIO-port & GPIO-pin \\ \hline \hline
		GPIOA & 1 \\ \hline
		GPIOA & 10 \\ \hline
		GPIOA & 13 \\ \hline
	\end{tabular}
	\caption{GPIO-pinnar på port A som ej går att koppla sensorer till.}
	\label{tab:Ogiltliga pinnar}
\end{table}

Vid uppstart initieras först portarna och pinnarna på mikrodatorn så de kan adresseras och avläsas på rätt sätt. Därefter startas en System Timer (SysTick) som används som klocka.
Fortsättningsvis detekterar systemet hur många rörelse- och vibrationssensorer som är inkopplade till kortet, och på vilka pinnar de är kopplade. För att vibrationssensorerna skall detekteras får de ej utsättas för vibrationer under uppstart.

Efter detekteringen skapas datarepresentationer med förinställda värden för de
sensorer som systemet hittat. Efter att samtliga datarepresentationer är skapade skickas
en lista av de inkopplade sensorerna till centralenheten som bestämmer vilka sensorer som ska vara aktiva
samt sätter centrala och lokala larmavståndet för rörelsesensorerna.
Systemet itererar nu över alla inkopplade sensorer enligt figur \ref{fig:MotionFlow}. \newpage


\begin{figure}
\centering
\includegraphics[scale=0.3]{figurer/FlowchartMotion.png}
\caption{Flödesschema över rörelseenheten funktionalitet som visar vilka beslut systemet tar beroende på externa och interna händelser.}
 \label{fig:MotionFlow}
\end{figure}

Rörelseenhetens flöde bygger på polling. Polling är smidigt då avståndsmätarna skickar och tar emot pulser av olika längd
och behöver då ha timers som håller koll på detta. Ifall detta hade skett via fördröjningsfunktioner hade alla andra sensorer
inte fungerat under pulsmätningar och en säkerhetsrisk skulle uppstå. Avbrottshantering är en annan lösning på problemet,
men då alla sensorer prioriteras lika är polling den simplare lösningen.


\textbf{Rörelsesensorn}:
En rörelsesensor tar upp 3 pinnar och det får därmed plats med 5 rörelsesensorer per port.
Trig- och echo-pinnen från HC-SR04 samt en LED-lampan kopplas respektive till  pin-\textit{n}, -$(n+1)$ och -$(n+2)$.


Sensorn aktiveras genom att MD407-enkortsdatorn skickar en hög puls till sensorn i minst 10 mikrosekunder,
varpå sensorn skickar ut ultraljudsvågor och sänder en hög puls till MD407-enkortsdatorn fram tills ultraljudsvågorna har återvänt.
Avståndet till närmaste föremål beräknas genom att mäta längden på pulsen. HC-SR04 kan mäta avstånd upp till 400 cm.

Rörelsesensorn har både centralt och lokalt larm. Avståndet för centrala larmet ställs in av centralenheten via CAN-kommunikation
upp till 400 cm. När det centrala larmet går skickas ett CAN-meddelande till centralenheten som agerar därefter.
Avståndet för lokala larmet sätts automatiskt till två gånger det centrala larmavståndet. Ifall centrala larmsvtåndet är över 200 cm kommer
lokala larmavståndet sättas till 400. När det lokala larmet går tänds en LED-lampa tills sensorn inte längre känner av något inom
det lokala larmavståndet.

\textbf{Vibrationssensorn}:
En vibrationssensor tar upp 2 pinnar och får därmed plats med 8 vibrationssensorer per port.
En pinne för digital-output från SW-18010P och en LED-lampa kopplas till pin-\textit{n} respektive pin-$(n+1)$.

Sensorn sänder kontinuerligt en hög puls till MD407-enkortsdatorn utom när den
känner av vibrationer, då den istället sänder en låg puls. Sensorns känslighet justeras fysiskt genom en komparator på sensorn.
Vibrationssensorn har endast central larm som skickas via CAN.

\clearpage
 \section{Resultat}
 För kompletta testspecifikationer hänvisas till bilaga \ref{bilaga:tester}.

 % Detta avsnitt redovisar resultatet av genomförd verifirering av systemet; dels fördelarna, dels för komplett system. Detta avsnitt redovisar även resultatet av det slutgiltiga fysiska testet när hela systemet körs i skarpt läge. Ni ska främst redovisa resultat i form av funktionalitet, men ta ocks upp prestanda aspekter om dessa är viktiga. Diskutea hur väl ni lyckats med er slutprodukt i förhållande till er projektplan.
 \subsection{Larmsystemet som helhet}

 Larmsystemet fyller all funktionalitet som beskrevs i projektplaneringen.
 Systemet som testats har bestått av en dörrenhet, en rörelseenhet, och en centralenhet.
 Det har även testats att ha en störenhet kopplad till systemet, för att testa systemet mot brusmeddelanden.
 Kommunikationen mellan enheterna fungerar och har skett via en CAN-buss som planerat.

 Periferienheterna har funktionaliteten att larma både lokalt och centralt, och kan ta emot konfigurationer till sensorerna från centralenheten. Ifall en periferienhet inte svarar på centralenhetens regelbundna konfigurationsmeddelande larmas det centralt, detta för att säkerställa att enheter inte kopplas ur systemet.

 Tester visar med god säkerhet att larmmeddelanden når centralenheten även med mycket brus på CAN-bussen. Tester har även visat att centralenheten kan hantera att skicka stora mängder meddelanden utan att något meddelande förloras.
 När en sensor på en enhet begär ett centralt larm fortsätter den att larma tills att centralenheten har skickat ett avlarmningsmeddelande.
 Ifall en enhet larmar centralt men inte ackrediterats skickas ett nytt larm för att säkerställa att centralenheten hanterar larmet.

 Efter att återspelningsenheten testats så att den fungerar som förväntat (se bilaga \ref{test:replayer}) så testades systemet mot återuppspelningsattacker (se bilaga \ref{test:sessionID}). Detta visade att systemet med hjälp av sessions-id klarar av att förhindra återuppspelningsattacker. Det faktum att återspelaren lyckades begära ett id har den enkla förklaring att meddelanden inte filtreras på sessions-id innan id-tilldelningen är färdig (se bilaga \ref{bilaga:protokoll}).

 \subsection{Centralenheten}
 Centralenheten har följande funktionalitet:
 \begin{enumerate}
     \item Tilldelning av id till periferienheter.
     \item Konfiguration av periferienheter via USART.
     \item Automatisk detektering av enheter som lämnar nätverket.
     \item Larmhantering.
 \end{enumerate}

 \begin{itemize}
\color{white}
\item Abra kadabra blankrad!
\end{itemize}

 För att säkerställa ovan nämnda funktionalitet utfördes följande tester:
 \begin{enumerate}
     \item Test av id-begäran och larmmeddelnade, se bilagor \ref{test:UrkopplingMotion} och \ref{test:idLarm}.
     \item Konfigurering av rörelseenhet, se bilaga \ref{test:MotionConfig}
\end{enumerate}

Utöver ovan nämnda tester är centralenheten involverad i alla de testar som inkluderar kommunikation mellan enheter. Även i de systemövergripande testerna (\ref{test:brusTest} och \ref{test:replayer}) har centralenheten presterat som förväntat. Centralenheten har klarat att kommunicera med periferienheter trots mycket trafik på CAN-bussen och även förhindrat återuppspelningsattack genom sessions-id. Allt som allt klarar centralenheten det som förväntas. Dock skulle  ett mer användarvänligt kommandogränssnitt vara önskvärt då det nuvarande kan upplevas som klumpigt.



 \subsection{Dörrenheten}

Dörrenheten har följande funktionalitet:
 \begin{enumerate}
     \item Detektering av antalet stängda dörrar kopplade på enkortsdatorn.
     \item Signalering via LED-lampa som indikerar att dörrenhetens initiering är färdig.
     \item Lokal larmning via LED-lampa och ljud.
     \item Central larmning via CAN-buss.
     \item Går att konfiguera väntetider innan larm från centralenheten.
     \item Avlarmning av individuella dörrar från centralenheten.
     \item Dörrar kan konfigueras ifrån centralenheten.
     \item Lokal funktionalitet kräver inte uppkopplad centralenhet.
     \item Stöd för 32 dörrar.
 \end{enumerate}


 \begin{itemize}
\color{white}
\item Hokus pokus jag har tappat mitt fokus.
\end{itemize}

 För att säkerställa att funktionalitet ovan fungerar utfördes följande tester:
 \begin{enumerate}
     \item Test av pinnar för dörrar \ref{test:portTest}
     \item Test av lokal drift \ref{test:localDrift}
     \item Test av id-tilldelning och larm \ref{test:idLarm}
     \item Test av system med brus \ref{test:brusTest}
     \item Test av återuppspelningsattack \ref{test:replayer}
 \end{enumerate}

 \subsection{Rörelseenheten}

Rörelseenheten klarar att hantera ett flertal vibrations- och rörelsesensorer samtidigt, upp till 23 sensorer,
och möjligheten att koppla upp flera rörelseenheter till samma centralenhet finns.

Rörelseenheten har följande funktionalitet:
 \begin{enumerate}
 	\item Automatiskt detektera antalet inkopplade rörelse- och vibrationssensorer vid uppstart.
	\item Larma vid upptäckt av vibrationer, rörelse och urkoppling av aktiv sensor.
    \item Central larmning via CAN-buss.
	\item Avlarmning via centralenheten.
	\item Lokal larmning för rörelsesensorer via LED-lampa.
	\item Konfigurerbara larmvillkor från centralenheten.
	\item Avaktivering av sensorer.
	\item Kalibrering av rörelsesensorerna via centralenheten.
 \end{enumerate}

 \begin{itemize}
\color{white}
\item Sim sala bim, nu är det radbyte!
\end{itemize}

 För att säkerställa att funktionalitet ovan fungerar utfördes följande tester:
 \begin{enumerate}
	\item Test av portar samt lokalt och centralt larm för rörelseenheten.\ref{test:PortMotion}
	\item Konfiguration och kalibrering av rörelseenheten.\ref{test:MotionConfig}
	\item Urkopplingslarm rörelseenheten.\ref{test:UrkopplingMotion}
	\item Prestandatest rörelseenheten.\ref{test:MotionPrestanda}
 \end{enumerate}

\newpage
\section{Diskussion och slutsats}
% Detta avsnitt innehåller en sammanfattning av konstruktionen och en diskussion av resultatet. Om detta är möjligt, dra slutsatser av ert projekt och identifiera förbättringsmöjligheter. (Vilka kan vara användbara för en beställare)

Tidigt i projektets gång var vi tvungna att välja mellan polling eller avbrott för att respondera på externa händelser för dörr- och rörelseenheten.  Polling valdes dels för att koden blir lättare att förstå och lättare att underhålla, men även för att tanken med systemet är att inget larm ska ha högre prioritet än något annat.

Skulle dörrenhetens mjukvara utvecklats med avbrott hade den enda fördelen varit möjligheten att dela upp dörrarna så att de hade olika prioritet på CAN-bussen, vilket skulle kunna resultera i att vissa larm skulle kommit fram till centralenheten snabbare än de hade med polling.
Tiden man tjänar in handlar om millisekunder, och eftersom MD407-enkortsdatorn endast stöttar 16 avbrottslinor skulle det ändå behövas  någon form av polling ifall systemet ska ha mer än 16 dörrar.
Prestandatestet som utfördes visade inte på någon märkbar fördröjning, så valet med polling känns högst befogat, se bilaga \ref{test:prestandaTest}

Polling har även använts till stor fördel inom rörelseenheter, med hjälp av polling kan flera rörelsensorer mätas av samtidigt, då det inte behövs blockerande väntetid-funktioner för att mäta/vänta en specifik tid.
Uppoffringen som görs är precision, med ett polling system är det svårt att vänta exakta tider, då det endast kollas ifall en tidsvariabel har överstigit en annan, och det går lite tid mellan att dessa villkor kollas.
Denna tid är dock såpass liten och skillnader i väntetider är såpass osignifikanta att det inte påverkar systemets funktionalitet, se bilaga \ref{test:MotionPrestanda}.

Systemet klarar av att skydda sig mot simpla uppspelningsattacker men ifall någon har lite insikt i hur systemet skyddar sig mot detta
skulle en attack mot systemet vara möjligt. En framtida förbättring skulle vara att implementera krypterade meddelanden för
att öka systemets säkerhet.

Samtliga delsystem har uppnått de grundkrav som formulerades i målsättningen, men även utrustats med
ytterligare funktionalitet som varit naturlig att implementera under projektets gång. Rörelse- och dörrenheten
kan ha upp till 23 respektive 32 sensorer och centralenheten kan ha upp till 32 periferienheter.
Med denna information kan vi dra slutsatsen att ett skalbart larmsystem är uppnåt, dock finns det rum för säkerhetsutveckling.
% Referenser enligtIEEE.
%För referenser
\bibliographystyle{IEEEtran}
\bibliography{referenser}

% Avslutningsvis så vill vi påminna om att projektets slutrapport, precis som projektplanen, ska vara projektintern, det väl säga att den ska beskriva det tekniska utvecklingsarbetet och bortse från att projektarbetet faktiskt organiserats inom ramen för en kurs.

\appendix
    \section{Utförlig beskrivning av meddelandetyper kommunikationsprotokoll}
    \label{bilaga:protokoll}
        \input{../protokoll/protokollInput.tex}

    \section{Kommandolista för centralenheten}
    \label{kommandon}
        För att styra centralenheten används ett antal kommandon som beskrivs nedan.

    \textbf{start}\\
    Startar standardläge.

    \textbf{list}\\
    Skriver ut alla periferienheter i terminalen och anger varje sensors konfiguration. Detta kommando används med fördel för att ta reda på vilka värden som är lämpliga för kommandona dor och ror (se nedan).

    \textbf{dor v x y z}\\
    Där \textbf{v, x, y} och \textbf{z} är tal mellan 0 och 9. Konfigurerar dörr \textbf{x} på enhet med id \textbf{v} med timer för lokalt larm på  \(\textbf{y} * 10\) sekunder samt en fördröjning till centralt larm på \(\textbf{z} * 10\) sekunder.

    \textbf{ror x y z}\\
    Där \textbf{x, y} och \textbf{z} är tal mellan 0 och 9. Konfigurerar rörelsesensor \textbf{y} på enhet med id \textbf{x} för att larma då den detekterar ett föremål på ett avstånd mindre än \(\textbf{z} * 10\) centimeter.

    \textbf{avlarma y z} \\
    Avlarmar sensor \textbf{z} på rörelseenhetenhet med id \textbf{y}. Detta kommando är lösenordsskyddat.

    \textbf{larma y z} \\
    Larmar sensor \textbf{z} på rörelseenhet med id \textbf{y}. Alla sensorer är larmade som standard så detta kommando körs om man vill återaktivera larm efter att det avaktiverats. Detta kommando är lösenordsskyddat.

    \textbf{inak y z} \\
    Inaktiverar sensor \textbf{z} på enhet med id \textbf{y}. Detta kommando är lösenordsskyddat.

    \textbf{ak y z} \\
    Aktiverar sensor \textbf{z} på enhet med id \textbf{y}. Alla sensorer är aktiverade som standard så detta kommando körs om man vill återaktivera en sensor efter att den inaktiverats. Detta kommando är lösenordsskyddat.

    \textbf{kal x y z} \\
    Startar översändning av kalibreringsmeddelanden till rörelsesensor \textbf{y} på rörelseenhet med id \textbf{x}. Det upplätta avståndet för givaren är \(\textbf{z} * 10\). Kalibrering fungerar inte om sensorn är inaktiverad.

    \textbf{nokal y z} \\
    Avslutar översändning av kalibreringsmeddelanden för sensor \textbf{z} på enhet \textbf{y}.


	\clearpage
	\section{Tester}
    		\label{bilaga:tester}
     	\input{../tester/dorrenhet/portTest.tex}
	\input{../tester/rorelseenhet/GPIO_TEST.tex}
	\input{../tester/rorelseenhet/MotionKonfiguration.tex}
	\input{../tester/rorelseenhet/UrkopplingMotion.tex}
	\input{../tester/rorelseenhet/MotionPrestanda.tex}
         \input{../tester/system/IDochLarm.tex}
         \input{../tester/dorrenhet/lokalDriftTest.tex}
         \input{../tester/dorrenhet/performanceTest.tex}
         \input{../tester/system/brusTest.tex}
         \input{../tester/system/replayer.tex}
         \input{../tester/system/sessionIDtest.tex}

\end{document}
