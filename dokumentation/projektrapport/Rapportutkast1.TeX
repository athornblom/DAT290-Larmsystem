\documentclass{article}
\usepackage[swedish]{babel}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}

%Lägger till Referenser i Innehållsförteckningen
\usepackage[numbib]{tocbibind}
\usepackage{float}
\usepackage{parskip}
\usepackage{todonotes}
\usepackage{url}
\usepackage{hyperref}

\title{Larmsystem baserat på MD407-mikrodatorer}
\author{Grupp 13}
\date{Läsperiod 1, HT-2019}

% I utvärderingen granskas hur väl studenterna i sina rapporter har lyckats visa att de genom de teknikutvärderingar, konstruktionsval, tester och analys som de har gjort har förstått de problem de har ställts inför, samt hur de på basis av denna förståelse och utifrån rådande förutsättningar har lyckats agera för att lösa dessa problem.

% Kriterierna är läsarorienterade vilket innebär att de ska bedöma en utomstående läsaresmöjligheter att förstå rapporten. Rapporten ska först och främst ses som ett dokument vars läsare finns inom organisationen där arbetet sker,men det ska kunna läsas och förstås av personer som inte har jobbat med och därför inte är insatta i projektet, exempelvis en nyanställd som inte känner till projektet och dess bakgrund, en anställd i en annan organisation med liknande verksamhet eller en ingenjörsstudent inom datateknik som har gått en liknande utbildning på en annanhögskola.

% En bakåtsyftande projektrapport: “Rapporten beskriver utvecklingen av…”




\begin{document}

%Titelsida
\maketitle
\pagenumbering{gobble}
\newpage

\tableofcontents
\newpage

\pagenumbering{arabic}


\section{Inledning}


\subsection{Syfte} % Svarar på frågan "Varför"?
Projektet är menat att 



Rapportens syfte är att beskriva utvecklingen av ett larm- och
 låssystem som i grunden består av ARM-baserade MD407-datorer
  som exekverar kod skriven i programmeringsspråket C.

Systemets uppgift är att öka säkerheten och översikten av
 användarens lokaler, genom att möjliggöra för
 datarepresentationer av önskade dörrar. Användaren
 kan sedan använda dessa representationer för att konfiguera
 individuella dörrar efter unika behov, där exempel på
 konfigurationsalternativ är uppställningstid innan larm,
  eller upplåsningskod.

Systemet tillåter även hårdvarumässiga utökningar av
rörelse- och/eller vibrationssensorer.

Användning av systemet förutsätter ingen speciell
teknisk expertis.

\subsection{Mål} % Svarar på frågan "Vad"?
% I detta avsnitt beskrivs koncist samtliga övergripande tekniska mål med projektet, det vill säga, vad som ska konstrueras. De mål som anges här kommer att styra projektets utveckling. När projektet närmar sig sitt slut och den slutliga projektrapporten lämnas in kommer beställaren att kritiskt analysera hur väl projektet lyckats genom att jämföra planens mål med den tekniska konstruktion som redovisas i projektrapporten.

Larm- och låssystemet skall konstrueras av en dörrenhet och en rörelseenhet, kopplade till en central larmenhet.

Dörrenheten skall ha stöd för en justerbar mängd dörrar. Varje dörr i systemet utrustas med en dörrsensor kopplad till en MD407 minidator, som sköter lokallarmning och kan begära centrallarm cia centralenheten.

Rörelseenheten är uppbyggd med avståndsmätare och vibrationssensorer. Likt dörreneheten kopplas en justerbar mängd av dessa sensorer till en MD407 minidator, som kan begära centrallarm vid behov.

Centralenheten är också en MD407 minidator, den hanterar konfiguration av periferienheterna och larmning. Ett larm som går på centralenheten skall kunnas stängas av via en pin-kod kopplad till enheten som larmar. Centralenheten skall även sköta initial konfiguration av systemet samt se till att inga enheter kan kopplas in/ut när systemet är i drift.

\subsection{Arbetsmetod} % svarar på frågan "hur har vi gått tillväga i det tekniska utvecklingsarbetet"?
\subsubsection{Subgrupper}
För att förhindra stockning i projektet delades projektgruppen in i tre grupper om två personer vardera, en för varje periferienhet, då parallellt arbete ansågs effektivare.

\textbf{Centralenheten}: Gruppen består av Josef och Filip. Målet är att kunna styra alla de andra periferienheterna från centralenheten samt implementera CAN-bussen.

\textbf{Dörrenheten}: Gruppen består av Adam och Gustav. Dörrenheten ansvarar för att alla dörrar skall vara uppkopplade och larmade.

\textbf{Rörelseenheten}: Gruppen består av Erik och Ben. Rörelseenheten utvecklar mjukvaran till rörelse- och vibrationssensorerna för larmning av t.ex. fönster och värdefulla föremål.

\subsubsection{Kommunikation}
Under projekets gång har arbetsgruppens medlemmar skött den skriftliga interna kommunikationen via en gemensam Messenger-chatt.
I chatten har medlemmarna kunnat ställa projektrelaterade
frågor till varandra. Den har även använts för att uppdatera varandra om när, var och hur de skulle arbeta samt om kommande mötestider.
\subsubsection{Möten och arbetstid}
Projektgruppen har haft ett möte med handledare varje vecka, där gruppen har gått igenom vad som gjorts sedan senaste mötet och hur mycket tid varje gruppmedlem har lagt ner. Dessutom har eventuella förändringar diskuterats på dessa möten med stöd av handledaren.

Projektgruppen har även haft två bestämda arbetstillfällen varje vecka där de flesta medlemmar har närvarat.

Utöver de bestämda arbetspassen har gruppen jobbat i sina undergrupper på lite mer spontana arbetspass. Under
dessa tillfällen har undergrupperna även kunnat ta hjälp av
andra undergrupper då gruppen har suttit i labbsalen.

Varje gruppmedlem har även lagt tid utanför dedikerad arbetstid.

\subsubsection{Fildelning och versionshantering}
För att förenkla det parallella programmerandet, och för att samla alla filer och dokument på ett och samma ställe, så valde arbetsgruppen att använda versionshanteringstjänsten GIT.


\section{Teknisk beskrivning} % Vad är utgångspunkten för i förkonstruktionsarbetet?
\subsection{Teknisk bakgrund}
Mjukvaran till Larmsystemet körs på ett flertal MD407-kort,vilket är en enkortsdator.
\subsection{Systemöversikt}

Systemet utgår från en centralenhet, kopplad till en dörrenhet och en rörelsenhet över en gemensam CAN-buss. Periferienheterna hanterar avmätning av sina respektive sensorer, samt begär larm via CAN-bussen vid behov. När det går ett centralt larm fortsätter larmet tills en användare slår av larmet via en pin-kod till centralenheten.

Dörrenheten är kopplad till ett antal strömbrytare/dörrsensorer, och larmar då en dörr är öppen för länge, först lokalt och sedan centralt.
Rörelseenheten är kopplad till ett antal avstånds- och vibrationsensorer, och larmar centralt om ett föremål detekteras av en avståndsmätare inom konfigurerbart avstånd. Rörelseenheten larmar även centralt om en vibrationssensor mäter en konfigurerbar mängd vibrationer inom en viss tidsram. % Lite flummig beskrivning kanske, får ändra när koden är klar.

En översikt av hårdvaran och hur den är kopplad finns i Figur \ref{fig:hårdvara}.
\begin{figure}[H] % Samma figur som projektplanen, då hårdvaran fortfarande ser likadan ut, det är värt att göra en ny innan slutgiltiga rapporten.
    \centering
%    \includegraphics[width=1\textwidth]{figurer/HardvaraOversikt.jpg}
    \caption{Översikt Hårdvara}
    \label{fig:hårdvara}
\end{figure}

När centralenheten samt periferienheterna startar befinner de sig i konfigurationsläge, där de först konfigurerar sina egna enheter (USART, CAN-bussen, GPIO), varpå centralenheten skickar konfigurationer för sensorerna till periferienheterna, som de använder för att konfigurera sina respektive sensorer. Efter att ha konfigurerats går enehterna i var sin kontinuerlig loop. Periferienheterna mäter ständigt av sensorerna och skickar larm-meddelanden över CAN-bussen till centralenheten vid behov. Centralenheten skickar periodiskt konfigurationer till periferinheterna och larmar när de inte bekräftas.

En överblick av mjukvarans tidsflöde finns i Figur \ref{fig:tidsflöde}.

\begin{figure}[H]
    \centering
%    \includegraphics[width=1\textwidth]{figurer/TidsFlode.jpg}
    \caption{Tidsflöde Mjukvara}
    \label{fig:tidsflöde}
\end{figure}


\subsection{CAN-kommunikation}
\label{can}
\subsubsection{Protokoll}
Protokollet som har skapats för kommunikationen mellan enheterna bygger på protokollet Controller Area Network (CAN).
CAN är ett bussprotokoll som främst används för kommunikation mellan datorer och givare på fordon där det ställs höga krav på tillförlitlighet.
För att undvika kollisioner och därmed öka tillförlitligheten har CAN en dominant logisk nivå (0) som dessutom ger automatisk prioritering av meddelanden då den dominanta nivån har företräde på bussen.
Denna prioritering har använts för att ge brotskande meddelande företräde över meddelande som inte kräver kort responstid. I tabell \ref{tab:meddelandetyper} är de meddelandetyper som använts kortfattat beskrivna. För en mer detaljerad beskrivning av protokollet och dess meddelandetyper se bilaga \ref{bilaga:protokoll}.



\begin{table}[H]
	\centering
	\begin{tabular}{|c|p{0.8\textwidth}|}
		\hline
		Meddelandetyp & Används till \\ \hline \hline
		Bekräftelse		& Bekräftelse för senaste mottagna meddelandet. \\ \hline
		Skicka larm		& Talar om för centralenheten om någon dörr eller sensor larmar. \\ \hline
		Skicka konfiguration		& Används för att skicka konfigurationer. \\ \hline
		Tilldelning av ID		& Används då centralenheten tilldelar en periferienhet dess ID. \\ \hline
		ID-begäran		& Detta meddelande skickas som en begäran av ID. \\ \hline

	\end{tabular}
	\caption{Listar de meddelandetyper som används för datakommunikationen. Uppifrån och ned sjunkande prioritering.}
	\label{tab:meddelandetyper}
\end{table}


\subsubsection{Implementation}
För hantering av CAN-meddelanden har STM-biblioteket (se \ref{stm}) använts för inledande initiering, hantering av avbrott samt för att skicka meddelanden.
Utöver detta har det skapats ett system för hantering av mottagana meddelanden.
Detta har lösts med avbrott där hanteringsfunktionen paras ihop med filtret för tillhörande meddelande.
Hanteringsfunktionen anropas sedan av avbrottsrutinen då ett meddelande passerat filtret.
Denna lösning har valts då de flesta meddelanden naturligt hanteras med en kort hanteringsfunktion som inte kräver input från användaren.



\subsection{Delsystem }
\subsubsection{Centralenheten}
%\label{subsec:centralenhet}
Centralenheten styr och håller koll på övriga enheter.
 Inställningar görs via USART, varpå de vidarebefordras till rätt periferienhet via CAN (se \ref{can}).

Centralenheten har följande två lägen:

\begin{enumerate}
    \item Standardläge: Enheten väntar på larm-meddelanden från periferienheterna eller användarinput via USART. Dessutom skickar den regelbundet  konfigurationen för anslutna dörrar och sensorer till periferienheterna, som förväntas bekräfta konfigurationen. Om en enhet inte svarar efter ett förbestämt antal meddelanden går larmet.
    \item Konfigurationsläge: Enheten startar i detta läge.
     Här kan användaren konfigurera anslutna dörr- och
 rörelseenheter via USART. Användaren kan sätta centralenheten
      i detta läge via USART för att lägga till eller konfigurera periferienheter.
\end{enumerate}

För att kunna adressera olika periferienheter måste centralenheten tilldela dessa varsitt unikt id. Detta görs i konfigurationsläget genom att varje enhet som saknar id skickar en förfrågan via CAN. När centralenheten tar emot en sådan förfrågan från en periferienhet, skickar den tillbaka det lägsta lediga id:t och skapar en ny instans av en struktur som representerar periferienheten och lägger den i en
lista. Strukturen innehåller enhetens id och konfiguration (d.v.s. tider för varje dörr för dörrenheter respektive avstånd för varje avståndssensor och antal vibrationssensorer för rörelseenheter).
Id:t används för att addressera meddelanden till samt identifiera meddelanden från enheten. Det är också periferienhetens index i centralenhetens lista, vilket innebär att det är oerhört effektivt att hitta rätt enhet i listan när dess id har lästs i CAN-meddelandet.





\subsubsection{Dörrenheten}
\label{subsec:Dörrenheten}
% Punkter att få med:
% - Systemuppstart
% - Lokala / Centrala Larm 
% - CAN
% - Initiering?
% - Systick?
% - Bilder?

Dörrenheten är en av systemets fristående enheter och kräver en MD407-mikrodator för drift.

Fyra av mikrodatorns fem GPIO-portar är designerade för dörranvändning, och en port är designerad för CAN-användning, samt för upplysning av användaren om att systemet körs på rätt sätt. Detta innebär att systemet har stöd för 32 inkopplade dörrar samtidigt per mikrodator. 

Vid systemuppstart kommer läget på samtliga I/O-Pins kontrolleras

deteketeras alla stängda dörrar som är inkopplade i mikrodatorn. Kongifugerbara datarepresentationer av dessa dörrar skapas med basvärden för lokala och centrala larmtider. Larmtiderna sätts med 10-sekunders intervall. Dessa basvärden kan ändras i källkoden, eller konfigueras om från centralenheten.


Dörrenheten kan köras i lokaldrift men bör för bästa effekt köras uppkopplad mot centralenheten.\\



\subsubsection{Rörelseenheten}
Denna periferienhet använder avståndssensorer av modellen HC-SR04, och vibrationssensorer av modellen SW-18010P, som styrs av ett MD407-kort.
Vid uppstart av systemet skall alla inkopplade sensorer tilldelas ett id som säger vilken sorts sensor det är och numrerar dem.

\textbf{Avståndssensorn}: Aktiveras genom att MD407-kortet skickar en hög puls till sensorn i minst 10 mikrosekunder, 
 varpå sensorn skickar ut ultraljudsvågor och sänder en hög puls tills ultraljudsvågorna kommer tillbaks till MD407-kortet, där avståndet till närmaste föremål beräknas genom att mäta längden på pulsen. 
HC-SR04 kan mäta avstånd upp till 400cm och larmavståndet är justerbart från centralenheten.

\textbf{Vibrationssensorn}: Sensorn sänder ständigt en hög puls till MD407-kortet förutom när den känner av vibrationer, då den istället sänder en låg puls. 
Sensorns känslighet justeras fysiskt genom en komparator på sensorn.



% Användarhandledning?

\section{Metoder}
\label{stm}
\subsection{Verifikation}
\todo[inline]{Har inte utfört några tester}
\subsection{Programbibliotek}
\label{stm}
För att minska arbetet har programbiblioteket STM32\cite{stm}
använts. Detta har används vid initieringar av GPIO-portar, Systick med mera.

\section{Resultat och diskussion} % Kan dela upp dessa om vi vill.
% Detta avsnitt redovisar resultatet av genomförd verifirering av systemet; dels fördelarna, dels för komplett system. Detta avsnitt redovisar även resultatet av det slutgiltiga fysiska testet när hela systemet körs i skarpt läge. Ni ska främst redovisa resultat i form av funktionalitet, men ta ocks upp prestanda aspekter om dessa är viktiga. Diskutea hur väl ni lyckats med er slutprodukt i förhållande till er projektplan.
\todo[inline]{Vi har inget resultat än}
\section{Slutsats}
% Detta avsnitt innehåller en sammanfattning av konstruktionen och en diskussion av resultatet. Om detta är möjligt, dra slutsatser av ert projekt och identifiera förbättringsmöjligheter. (Vilka kan vara användbara för en beställare)
\todo[inline]{Vi har ingen slutsats än}

% Referenser enligtIEEE.
%För referenser
\bibliographystyle{IEEEtran}
\bibliography{referenser}

% Avslutningsvis så vill vi påminna om att projektets slutrapport, precis som projektplanen, ska vara projektintern, det väl säga att den ska beskriva det tekniska utvecklingsarbetet och bortse från att projektarbetet faktiskt organiserats inom ramen för en kurs.

\section{Bilagor}
    \subsection{Utförlig beskrivning av meddelandetyper kommunikationsprotokoll}
    \label{bilaga:protokoll}
%        \input{../protokoll/protokollInput.tex}
\end{document}
